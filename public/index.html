<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Changmin Kang" />
    <title>내일배움캠프 Node.js 트랙 타워 디펜스 게임</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #2d2d2d;
        flex-direction: column;
      }
      #gameCanvas {
        border: 2px solid #000;
        display: none;
      }
      .button-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }
      .button-container button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="button-container">
      <h1 style="color: white">내일배움캠프 Node.js 트랙 타워 디펜스 게임</h1>
      <div id="auth-buttons"></div>
      <!-- <button id="registerButton">회원가입</button>
      <button id="loginButton">로그인</button> -->
      <button id="playButton">게임 플레이</button>
      <button id="coopModeButton">협동 모드</button>
    </div>
    <canvas id="gameCanvas" width="1200" height="700"></canvas>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script type="module">
      // 로그인 상태 확인 및 버튼 렌더링
      const authButtons = document.getElementById('auth-buttons');
      const token = localStorage.getItem('accessToken');
      const email = localStorage.getItem('email');

      if (token && email) {
        // 로그인 상태인 경우 로그아웃 버튼 표시
        const logoutButton = document.createElement('button');
        logoutButton.textContent = '로그아웃';
        logoutButton.addEventListener('click', async () => {
          try {
            const response = await fetch('http://localhost:3000/api/account/logout', {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`, // 토큰 포함
              },
              body: JSON.stringify({ email }),
              credentials: 'include', // 쿠키 포함
            });

            if (response.ok) {
              localStorage.removeItem('accessToken'); // 토큰 삭제
              localStorage.removeItem('email'); // 이메일 삭제
              alert('로그아웃 되었습니다.');
              window.location.reload(); // 페이지 새로고침
            } else {
              const result = await response.json();
              alert(result.message || '로그아웃에 실패했습니다.');
            }
          } catch (error) {
            console.error('Error during logout:', error);
            alert('서버와 통신 중 문제가 발생했습니다.');
          }
        });
        authButtons.appendChild(logoutButton);
      } else {
        // 비로그인 상태인 경우 로그인/회원가입 버튼 표시
        const loginButton = document.createElement('button');
        loginButton.textContent = '로그인';
        loginButton.addEventListener('click', () => {
          window.location.href = 'login.html'; // 로그인 페이지로 이동
        });

        const registerButton = document.createElement('button');
        registerButton.textContent = '회원가입';
        registerButton.addEventListener('click', () => {
          window.location.href = 'register.html'; // 회원가입 페이지로 이동
        });

        authButtons.appendChild(loginButton);
        authButtons.appendChild(registerButton);
      }

      document.getElementById('playButton').addEventListener('click', () => {
        document.querySelector('.button-container').style.display = 'none';
        document.getElementById('gameCanvas').style.display = 'block';
        import('./src/game.js');
      });

      // 협동 모드 버튼 이벤트
      document.getElementById('coopModeButton').addEventListener('click', () => {
        // 버튼 컨테이너 숨기기
        document.querySelector('.button-container').style.display = 'none';
        // 게임 캔버스 표시
        document.getElementById('gameCanvas').style.display = 'block';

        // 협동 모드 초기화 - co-op-game.js 로드
        import('./src/co-op-game.js')
          .then((module) => {
            module.initCoopWebSocket(); // WebSocket 연결 초기화
            setTimeout(() => module.initCoopMode(), 100); // 약간의 지연 후 협동 모드 초기화
          })
          .catch((err) => {
            console.error('협동 모드 로드 실패:', err);
            alert('협동 모드를 로드하는 데 실패했습니다.');
          });
      });
    </script>
  </body>
</html>
